name: Test and Score

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  run-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18
          
      - name: Install dependencies
        run: npm install
        
      - name: Run Jest tests and generate score
        id: run-tests
        run: |
          # Run tests and save results
          npx jest --json --outputFile=results.json || true
          
          # Calculate score if results file exists
          if [ -f results.json ]; then
            PASSED=$(jq '.numPassedTests' results.json)
            TOTAL=$(jq '.numTotalTests' results.json)
            
            if [ -z "$PASSED" ] || [ -z "$TOTAL" ]; then
              echo "Failed to parse test results"
              SCORE="0"
            else
              echo "Tests Passed: $PASSED / $TOTAL"
              SCORE=$(echo "scale=2; $PASSED * 0.4" | bc)
              
              if (( $(echo "$SCORE > 4" | bc -l) )); then
                SCORE="4"
              fi
            fi
          else
            echo "No test results found"
            SCORE="0"
          fi
          
          echo "SCORE=$SCORE" >> $GITHUB_ENV
          echo "score=$SCORE" >> $GITHUB_OUTPUT
          
      - name: Autograding Reporter
        uses: classroom-resources/autograding-grading-reporter@v1
        with:
          runners: test
          token: ${{ secrets.GITHUB_TOKEN }}
        env:
          SCORE: ${{ env.SCORE }}
